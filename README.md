# komtet-kassa-umi-cms

## Модуль КОМТЕТ Кассы для UMI CMS

Данное решение позволяет подключить Ваш интернет-магазин к облачному сервису КОМТЕТ Касса с целью соответствия требованиям 54-ФЗ для регистрации расчетов с использованием электронного средства платежа в сети Интернет.

### Возможности модуля
  - автоматическая фискализация платежей при оплате заказа клиентом,
  - автоматическая фискализация платежей при смене статуса заказа менеджером.

### Описание работы
Модуль реагирует событие когда клиент совершает оплату через один из подключенных модулей приема платежей (PayPal, Robokassa) либо менеджер магазина меняет статус оплаты заказа на "принята" либо на "отказ", и направляет данные о заказе в систему КОМТЕТ Касса.

Как только данные по заказу появляются в системе КОМТЕТ Касса, формируется чек, который записывается на фискальный накопитель кассового аппарата и он же отправляется в ОФД (Оператор Фискальных Данных). Если указано в настройках, аппарат может распечатать бланк чека.

Важно! 54-ФЗ обязует выдать электронный чек клиенту, для того чтобы электронный чек был выслан клиенту на электронную почту необходимо сделать обязательным поле email на форме оформления заказа.

### Установка
- скопируйте папку "/komtet_kassa" в папку "ваша_папка_с_umi_cms/classes/components/".
- в администраторской части сайта в левом меню выберите пункт "Модули", далее подпункт "Конфигурация", на открывшейся странице откройте вкладку "Модули"
- в нижней части страницы в поле "Путь до инсталляционного файла" укажите получившийся путь к модулю КОМТЕТ Кассы, а именно "classes/components/komtet_kassa/install.php"
- нажмите кнопку "Установить"

### Настройка модуля

Прежде чем приступить к настройке модуля, вам потребуется зарегистрироваться в [личном кабинете на сайте КОМТЕТ Касса](https://kassa.komtet.ru/signup).
Чтобы зайти в настройки, нажмите на название модуля в списке установленных модулей.
В настройках модуля необходимо указать:
- ID Магазина - в личном кабинете на сайте КОМТЕТ Касса зайдите слева в меню "Фискализация" -> «Магазины», далее выберете нужный магазин и зайдите в его настройки. Скопируете значение ID магазина.
- Секретный ключ магазина - аналогично предыдущему Скопируете значение Секретный ключ магазина.
- ID очереди - в личном кабинете на сайте КОМТЕТ Касса зайдите слева в меню "Фискализация" -> «Кассы», далее найдите нужную очередь в списке и скопируйте четырехзначное число после ID.
- СНО - укажите систему налогообложения вашей компании, которая будут использоваться при формировании чеков.
- Налоговая ставка - укажите налоговую ставку товаров, которая будут использоваться при формировании чеков.
- Печатать ли чек - включите или отключите печать бумажного чека. Отключает или включает только печать бумажной версии чека на фискальном регистраторе. Не влияет на электронную версию чека.

---

## Запуск проекта
* Склонировать репозиторий
```shell
git clone --recursive git@github.com:Komtet/komtet-kassa-umi-cms.git
```
* Скопировать файл install.php в папку /php
* Запустить сборку проекта:
```shell
make build 
```   
* Установить права на папку php:
```shell
sudo chmod -R 777 php
```
* Добавить запись в /etc/hosts
```sh
127.0.0.1       umi-kassa.localhost.ru
```
* Добавить nginx конфиги
```sh
cd /etc/nginx/sites-enabled
sudo ln -s [путь_до_проекта]/komtet-kassa-umi-cms/nginx.cfg umi.cfg
sudo nginx -t
sudo nginx -s reload
```
____
## Установка CMS
* Запустить проект:
```shell
make start
```
* Проект будет доступен по адресу: `http://umi-kassa.localhost.ru/`
* Для начала установки перейдите по адресу : `http://umi-kassa.localhost.ru/install.php`
* Настройки подключения к бд MySQL:
```
Имя хоста: mysql
Имя базы данных: test_db
Логин: devuser
Пароль: devpass
```

____
## Доступные команды из Makefile
* Собрать проект
```shell
make build
```
* Запустить проект
```shell
make start
```
* Остановить проект
```shell
make stop
```